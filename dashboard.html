<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Coffee Leaf Detection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
            background:url("https://i.ibb.co/Fq6T0mhq/organic-coffee-beans-still-life.jpg") no-repeat center center/cover;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .user-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .user-info h3 {
            color: #4a5568;
            margin-bottom: 5px;
        }

        .user-info p {
            color: #718096;
            margin: 0;
        }

        .logout-btn {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }

        .logout-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-weight: 600;
        }

        .tab.active {
            background: #667eea;
            color: white;
            border-bottom: 3px solid #764ba2;
        }

        .tab:hover:not(.active) {
            background: #f7fafc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background-color: #f7fafc;
            border-color: #764ba2;
        }

        .upload-area i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }

        .btn-info {
            background: linear-gradient(135deg, #4299e1, #3182ce);
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 4/3;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .camera-controls-overlay {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            pointer-events: auto;
        }

        .capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            border: 4px solid rgba(255,255,255,0.8);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .capture-btn:active {
            transform: scale(0.95);
            background: #f0f0f0;
        }

        .capture-btn-inner {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: white;
            border: 2px solid #e2e8f0;
        }

        .camera-switch-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        .camera-switch-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .camera-indicators {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            pointer-events: none;
        }

        .camera-status {
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .camera-resolution {
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .camera-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .camera-option-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 25px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .camera-option-btn.active {
            background: #667eea;
            color: white;
        }

        .camera-option-btn:hover:not(.active) {
            background: #f7fafc;
        }

        .results {
            margin-top: 25px;
        }

        .confidence-bar {
            background: #e2e8f0;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #68d391);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }

        .confidence-text {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .prediction-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .disease-info {
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
        }

        .severity-high { border-left-color: #f56565; background: #fed7d7; }
        .severity-medium { border-left-color: #ed8936; background: #feebc8; }
        .severity-low { border-left-color: #48bb78; background: #c6f6d5; }
        .severity-none { border-left-color: #a0aec0; background: #edf2f7; }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .metrics-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 5px 0;
        }

        .metric-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .preview-container {
            text-align: center;
            margin: 20px 0;
        }

        .preview-image, .preview-video {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #48bb78; }
        .status-offline { background: #f56565; }

        .notification-status {
            background: #e8f5e8;
            border-left: 4px solid #4CAF50;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        /* History Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-date {
            font-weight: bold;
            color: #4a5568;
        }

        .history-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-healthy { background: #c6f6d5; color: #22543d; }
        .status-diseased { background: #fed7d7; color: #742a2a; }

        .history-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .history-btn {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .btn-view { background: #4299e1; color: white; }
        .btn-download { background: #48bb78; color: white; }

        .empty-history {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .empty-history i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        /* .storage-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #856404;
        } */

        .camera-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .flash-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
        }

        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 0.8; }
            100% { opacity: 0; }
        }

        .analysis-in-progress {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .upload-area {
                padding: 20px;
            }
            
            .user-section {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .camera-controls, .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .history-item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .history-actions {
                flex-direction: column;
            }

            .capture-btn {
                width: 60px;
                height: 60px;
            }

            .capture-btn-inner {
                width: 48px;
                height: 48px;
            }

            .camera-switch-btn {
                width: 45px;
                height: 45px;
            }
        }
    </style>
    <!-- Include jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- User Info Section -->
        <div class="user-section">
            <div class="user-info">
                <h3>Welcome, {{ username }}! üëã</h3>
                <p>Ready to analyze your coffee leaves for diseases</p>
            </div>
            <a href="{{ url_for('logout') }}" class="logout-btn">üö™ Logout</a>
        </div>

        <div class="header">
            <h1>‚òï Coffee Leaf Disease Detection</h1>
            <p>AI-powered detection system with Email notifications</p>
        </div>

        <div class="metrics-panel">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>System Status</h3>
                <div id="connectionStatus">
                    <span class="status-indicator status-online"></span>
                    <span>Connected</span>
                </div>
            </div>
        </div>

        <!-- Storage Warning -->
        <!-- <div id="storageWarning" class="storage-warning hidden">
            <strong>‚ö†Ô∏è Storage Notice:</strong> 
            <span id="storageMessage">Browser storage is limited. Some history items may be automatically cleared.</span>
        </div> -->

        <!-- Tabs Navigation -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('imageTab')">üì∑ Image Upload</div>
            <div class="tab" onclick="switchTab('webcamTab')">üé• Live Camera</div>
        </div>

        <!-- Image Upload Tab -->
        <div id="imageTab" class="tab-content active">
            <div class="card">
                <h2>Upload Coffee Leaf Image</h2>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <i>üì∑</i>
                    <h3>Click to Upload Image</h3>
                    <p>Supported formats: JPG, PNG, JPEG (Max: 10MB)</p>
                    <input type="file" id="fileInput" accept="image/*" hidden onchange="handleImageUpload(this.files[0])">
                </div>
                <button class="btn" onclick="document.getElementById('fileInput').click()">Choose Image</button>
                
                <div id="imagePreview" class="preview-container hidden">
                    <h3>Image Preview:</h3>
                    <img id="previewImg" class="preview-image">
                </div>

                <div id="imageResults" class="results"></div>
            </div>
        </div>

        <!-- Webcam Tab -->
        <div id="webcamTab" class="tab-content">
            <div class="card">
                <h2>üì± Smartphone-Style Camera</h2>
                
                <!-- Camera Options -->
                <div class="camera-options">
                    <button class="camera-option-btn active" onclick="switchCamera('user')">üì± Front Camera</button>
                    <button class="camera-option-btn" onclick="switchCamera('environment')">üåø Back Camera</button>
                    <button class="btn btn-success" onclick="startCamera()">üé• Turn On Camera</button>
                    <button class="btn btn-danger" onclick="stopCamera()">‚èπÔ∏è Turn Off Camera</button>
                </div>

                <!-- Video Container with Camera Interface -->
                <div class="video-container">
                    <video id="videoElement" autoplay playsinline></video>
                    <canvas id="captureCanvas" style="display: none;"></canvas>
                    
                    <!-- Camera Overlay -->
                    <div class="camera-overlay">
                        <!-- Flash Effect -->
                        <div id="flashEffect" class="flash-animation"></div>
                        
                        <!-- Camera Indicators -->
                        <div class="camera-indicators">
                            <div class="camera-status" id="cameraStatus">Ready</div>
                            <div class="camera-resolution" id="resolutionDisplay">HD Ready</div>
                        </div>
                        
                        <!-- Camera Controls Overlay -->
                        <div class="camera-controls-overlay">
                            <button class="camera-switch-btn" onclick="switchCamera()">üîÑ</button>
                            <button class="capture-btn" onclick="capturePhoto()">
                                <div class="capture-btn-inner"></div>
                            </button>
                            <button class="camera-switch-btn" onclick="toggleFlash()">‚ö°</button>
                        </div>
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="cameraLoading" class="camera-loading hidden">
                        <div class="spinner"></div>
                        <p>Starting camera...</p>
                    </div>
                </div>

                <!-- Analysis Progress -->
                <div id="analysisProgress" class="analysis-in-progress hidden">
                    <div class="spinner"></div>
                    <h3>üîç Analyzing Image...</h3>
                    <p>Detecting diseases in the captured image</p>
                </div>

                <!-- Camera Preview -->
                <div id="cameraPreview" class="preview-container hidden">
                    <h3>üì∏ Captured Image:</h3>
                    <img id="capturedImg" class="preview-image">
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="retakePhoto()">üîÑ Retake Photo</button>
                        <button class="btn btn-info" onclick="analyzeCapturedImage()">üîç Analyze This Image</button>
                    </div>
                </div>

                <div id="webcamResults" class="results">
                    <div class="prediction-item">
                        <strong>Camera Ready</strong><br>
                        Turn on the camera and click the capture button to take photos. The system will automatically analyze for diseases.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeHistoryModal()">&times;</span>
            <h2>üìã Analysis History</h2>
            <p>View and download your previous analysis reports</p>
            
            <div class="history-controls" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-danger" onclick="clearAllHistory()" style="padding: 8px 15px; font-size: 0.9rem;">üóëÔ∏è Clear All History</button>
                <button class="btn btn-secondary" onclick="optimizeStorage()" style="padding: 8px 15px; font-size: 0.9rem;">üßπ Optimize Storage</button>
                <span id="historyCount" style="margin-left: auto; color: #718096; font-size: 0.9rem;"></span>
            </div>
            
            <div id="historyList">
                <!-- History items will be dynamically added here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'imageTab';
        let currentAnalysisData = null;
        let analysisHistory = [];
        const MAX_HISTORY_ITEMS = 15;
        const MAX_STORAGE_SIZE = 4 * 1024 * 1024;

        // Camera variables
        let currentStream = null;
        let currentCamera = 'user'; // 'user' for front, 'environment' for back
        let isCameraActive = false;
        let isFlashOn = false;
        let captureCanvas, captureContext;
        let currentCapturedImage = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkServerStatus();
            loadHistory();
            checkStorageStatus();
            
            // Initialize camera canvas
            captureCanvas = document.getElementById('captureCanvas');
            captureContext = captureCanvas.getContext('2d');
        });

        // ========== CAMERA FUNCTIONS ========== //

        // Start camera with smartphone-like interface
        async function startCamera() {
            if (isCameraActive) {
                return;
            }

            const videoElement = document.getElementById('videoElement');
            const loadingElement = document.getElementById('cameraLoading');
            const statusElement = document.getElementById('cameraStatus');
            
            try {
                // Show loading
                loadingElement.classList.remove('hidden');
                statusElement.textContent = 'Starting...';
                
                // Stop any existing stream
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                // Camera constraints
                const constraints = {
                    video: {
                        facingMode: currentCamera,
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                };

                // Get camera stream with timeout
                const streamPromise = navigator.mediaDevices.getUserMedia(constraints);
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Camera timeout')), 5000)
                );

                currentStream = await Promise.race([streamPromise, timeoutPromise]);
                videoElement.srcObject = currentStream;
                
                // Wait for video to be ready
                await new Promise((resolve) => {
                    videoElement.onloadedmetadata = () => {
                        videoElement.play().then(resolve);
                    };
                });

                isCameraActive = true;
                statusElement.textContent = 'Live';
                loadingElement.classList.add('hidden');
                
                // Update resolution display
                const resolution = `${videoElement.videoWidth}x${videoElement.videoHeight}`;
                document.getElementById('resolutionDisplay').textContent = resolution;

            } catch (error) {
                console.error('Error starting camera:', error);
                statusElement.textContent = 'Error';
                loadingElement.classList.add('hidden');
                alert(`Camera error: ${error.message}. Please ensure camera permissions are granted.`);
            }
        }

        // Stop camera
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            isCameraActive = false;
            document.getElementById('videoElement').srcObject = null;
            document.getElementById('cameraStatus').textContent = 'Off';
        }

        // Switch between front and back cameras
        async function switchCamera(cameraType = null) {
            if (cameraType) {
                currentCamera = cameraType;
            } else {
                // Toggle between front and back
                currentCamera = currentCamera === 'user' ? 'environment' : 'user';
            }
            
            // Update UI
            document.querySelectorAll('.camera-option-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.camera-option-btn')[currentCamera === 'user' ? 0 : 1].classList.add('active');
            
            // Restart camera if active
            if (isCameraActive) {
                await stopCamera();
                await startCamera();
            }
        }

        // Capture photo with flash effect
        function capturePhoto() {
            if (!isCameraActive) {
                alert('Please turn on the camera first!');
                return;
            }

            // Flash effect
            const flash = document.getElementById('flashEffect');
            flash.style.animation = 'flash 0.3s ease-in-out';
            setTimeout(() => {
                flash.style.animation = '';
            }, 300);

            // Capture image
            const videoElement = document.getElementById('videoElement');
            const width = videoElement.videoWidth;
            const height = videoElement.videoHeight;

            // Set canvas size to match video
            captureCanvas.width = width;
            captureCanvas.height = height;

            // Draw current video frame to canvas
            captureContext.drawImage(videoElement, 0, 0, width, height);

            // Convert to data URL for preview
            const imageDataUrl = captureCanvas.toDataURL('image/jpeg', 0.9);
            
            // Show preview
            const preview = document.getElementById('cameraPreview');
            const capturedImg = document.getElementById('capturedImg');
            capturedImg.src = imageDataUrl;
            preview.classList.remove('hidden');

            // Store for analysis
            currentCapturedImage = imageDataUrl;
            
            // Show analysis progress
            document.getElementById('analysisProgress').classList.remove('hidden');
            
            // Stop camera automatically after capture
            stopCamera();
            
            // Auto-analyze the captured image after a short delay
            setTimeout(() => {
                analyzeCapturedImage();
            }, 1000);
        }

        // Analyze the captured image
        async function analyzeCapturedImage() {
            if (!currentCapturedImage) {
                alert('No image captured! Please capture an image first.');
                return;
            }

            const resultsDiv = document.getElementById('webcamResults');
            const analysisProgress = document.getElementById('analysisProgress');
            
            // Show analysis in progress
            analysisProgress.classList.remove('hidden');
            analysisProgress.innerHTML = `
                <div class="spinner"></div>
                <h3>üîç Analyzing Image...</h3>
                <p>Detecting diseases in the captured image</p>
                <p><small>This may take a few seconds...</small></p>
            `;

            try {
                // Convert data URL to blob
                const response = await fetch(currentCapturedImage);
                const blob = await response.blob();

                // Create FormData and send for prediction
                const formData = new FormData();
                formData.append('file', blob, 'coffee_leaf_capture.jpg');

                const predictResponse = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });

                if (!predictResponse.ok) {
                    throw new Error(`Server responded with ${predictResponse.status}: ${predictResponse.statusText}`);
                }

                const data = await predictResponse.json();
                
                // Store the analysis data
                currentAnalysisData = { ...data, source: 'camera' };
                
                // Hide analysis progress
                analysisProgress.classList.add('hidden');
                
                // Add to history
                addToHistory(data, 'camera');
                
                // Display results
                displayResultsWithMarkedImage(data, 'webcamResults');
                
            } catch (error) {
                console.error('Analysis error:', error);
                analysisProgress.classList.add('hidden');
                resultsDiv.innerHTML = `
                    <div class="prediction-item severity-high">
                        <h3>‚ùå Analysis Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Please try capturing the image again or check your connection.</p>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="retakePhoto()">üîÑ Retake Photo</button>
                            <button class="btn btn-info" onclick="analyzeCapturedImage()">üîç Try Analysis Again</button>
                        </div>
                    </div>
                `;
            }
        }

        // Toggle flash (simulated)
        function toggleFlash() {
            isFlashOn = !isFlashOn;
            const flashBtn = document.querySelector('.camera-switch-btn:nth-child(3)');
            flashBtn.textContent = isFlashOn ? 'üí°' : '‚ö°';
        }

        // Retake photo
        function retakePhoto() {
            document.getElementById('cameraPreview').classList.add('hidden');
            document.getElementById('analysisProgress').classList.add('hidden');
            currentCapturedImage = null;
            
            // Clear previous results
            const resultsDiv = document.getElementById('webcamResults');
            resultsDiv.innerHTML = `
                <div class="prediction-item">
                    <strong>Camera Ready</strong><br>
                    Capture another image to analyze for diseases.
                </div>
            `;
            
            // Restart camera for retaking
            startCamera();
        }

        // ========== EXISTING FUNCTIONS ========== //

        // Improved localStorage management
        function loadHistory() {
            try {
                const stored = localStorage.getItem('coffeeLeafAnalysisHistory');
                if (stored) {
                    analysisHistory = JSON.parse(stored);
                    if (analysisHistory.length > MAX_HISTORY_ITEMS) {
                        analysisHistory = analysisHistory.slice(0, MAX_HISTORY_ITEMS);
                        saveHistory();
                    }
                }
                updateHistoryDisplay();
            } catch (error) {
                console.error('Error loading history:', error);
                showStorageWarning('Failed to load history. Storage may be full.');
                analysisHistory = [];
            }
        }

        function saveHistory() {
            try {
                const optimizedHistory = analysisHistory.map(item => ({
                    id: item.id,
                    timestamp: item.timestamp,
                    source: item.source,
                    data: {
                        predictions: item.data.predictions,
                        metrics: item.data.metrics,
                        status: item.data.status
                    }
                }));

                const historyString = JSON.stringify(optimizedHistory);
                
                if (historyString.length > MAX_STORAGE_SIZE) {
                    while (historyString.length > MAX_STORAGE_SIZE && analysisHistory.length > 1) {
                        analysisHistory.pop();
                    }
                    showStorageWarning('Storage limit reached. Oldest items have been removed.');
                }

                localStorage.setItem('coffeeLeafAnalysisHistory', JSON.stringify(analysisHistory));
                updateHistoryDisplay();
            } catch (error) {
                console.error('Error saving history:', error);
                if (error.name === 'QuotaExceededError') {
                    handleStorageFull();
                }
            }
        }

        function handleStorageFull() {
            while (analysisHistory.length > 5) {
                analysisHistory.pop();
            }
            
            try {
                localStorage.setItem('coffeeLeafAnalysisHistory', JSON.stringify(analysisHistory));
                showStorageWarning('Storage was full. Only keeping 5 most recent items.');
            } catch (e) {
                analysisHistory = [];
                localStorage.removeItem('coffeeLeafAnalysisHistory');
                showStorageWarning('Storage completely full. History has been cleared.');
            }
        }

        function checkStorageStatus() {
            try {
                const testKey = 'storage_test';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                hideStorageWarning();
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    showStorageWarning('Browser storage is full. History features disabled.');
                }
            }
        }

        function showStorageWarning(message) {
            const warning = document.getElementById('storageWarning');
            const messageEl = document.getElementById('storageMessage');
            messageEl.textContent = message;
            warning.classList.remove('hidden');
        }

        function hideStorageWarning() {
            document.getElementById('storageWarning').classList.add('hidden');
        }

        function optimizeStorage() {
            analysisHistory.forEach(item => {
                if (item.data.image_with_boxes) {
                    delete item.data.image_with_boxes;
                }
            });
            saveHistory();
            showStorageWarning('Storage optimized. Image data removed from history.');
        }

        function clearAllHistory() {
            if (confirm('Are you sure you want to clear all analysis history? This cannot be undone.')) {
                analysisHistory = [];
                localStorage.removeItem('coffeeLeafAnalysisHistory');
                updateHistoryDisplay();
                closeHistoryModal();
                showStorageWarning('All history has been cleared.');
            }
        }

        // Server status check
        async function checkServerStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                const statusElement = document.getElementById('connectionStatus');
                
                if (data.status === 'healthy') {
                    statusElement.innerHTML = '<span class="status-indicator status-online"></span><span>Server Online</span>';
                } else {
                    statusElement.innerHTML = '<span class="status-indicator status-offline"></span><span>Server Offline</span>';
                }
            } catch (error) {
                document.getElementById('connectionStatus').innerHTML = '<span class="status-indicator status-offline"></span><span>Connection Failed</span>';
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Stop camera when switching away from webcam tab
            if (currentTab === 'webcamTab' && isCameraActive) {
                stopCamera();
            }

            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;
        }

        // Image upload handling
        function handleImageUpload(file) {
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                alert('File size too large. Please select an image smaller than 10MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                const previewImg = document.getElementById('previewImg');
                previewImg.src = e.target.result;
                preview.classList.remove('hidden');
                predictImage(file);
            }
            reader.readAsDataURL(file);
        }

        // Image prediction
        async function predictImage(file) {
            const formData = new FormData();
            formData.append('file', file);

            const resultsDiv = document.getElementById('imageResults');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>üîç Analyzing image for diseases...</p><p>Detecting and marking disease spots</p></div>';

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                
                currentAnalysisData = { ...data, source: 'image' };
                addToHistory(data, 'image');
                displayResultsWithMarkedImage(data, 'imageResults');
            } catch (error) {
                console.error('Image analysis error:', error);
                resultsDiv.innerHTML = `
                    <div class="prediction-item severity-high">
                        <h3>‚ùå Analysis Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Please try uploading the image again.</p>
                    </div>
                `;
            }
        }

        // Add analysis to history
        function addToHistory(data, source) {
            const historyItem = {
                id: Date.now(),
                timestamp: new Date().toLocaleString(),
                source: source,
                data: data
            };
            
            analysisHistory.unshift(historyItem);
            
            if (analysisHistory.length > MAX_HISTORY_ITEMS) {
                analysisHistory = analysisHistory.slice(0, MAX_HISTORY_ITEMS);
            }
            
            try {
                saveHistory();
            } catch (error) {
                console.error('Error saving to history:', error);
            }
        }

        // Update history display
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            const historyCount = document.getElementById('historyCount');
            
            historyCount.textContent = `${analysisHistory.length} ${analysisHistory.length === 1 ? 'item' : 'items'}`;
            
            if (analysisHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-history">
                        <i>üìù</i>
                        <h3>No Analysis History Yet</h3>
                        <p>Your analysis history will appear here after you analyze coffee leaf images.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            analysisHistory.forEach(item => {
                const hasDisease = item.data.predictions && item.data.predictions.length > 0;
                const diseaseCount = hasDisease ? item.data.predictions.length : 0;
                const diseaseNames = hasDisease ? 
                    [...new Set(item.data.predictions.map(p => p.disease_info?.name || p.class))].join(', ') : 
                    'None';
                
                html += `
                    <div class="history-item">
                        <div class="history-item-header">
                            <div class="history-date">${item.timestamp} (${item.source})</div>
                            <div class="history-status ${hasDisease ? 'status-diseased' : 'status-healthy'}">
                                ${hasDisease ? 'Diseased' : 'Healthy'}
                            </div>
                        </div>
                        <div class="history-details">
                            <p><strong>Diseases Detected:</strong> ${diseaseNames}</p>
                            <p><strong>Spots Found:</strong> ${diseaseCount}</p>
                        </div>
                        <div class="history-actions">
                            <button class="history-btn btn-view" onclick="viewHistoryReport(${item.id})">üëÅÔ∏è View Details</button>
                            <button class="history-btn btn-download" onclick="downloadHistoryPDF(${item.id})">üì• Download PDF</button>
                            <button class="history-btn" style="background: #f56565; color: white;" onclick="deleteHistoryItem(${item.id})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }

        // Display results with marked image and treatments
        function displayResultsWithMarkedImage(data, targetDiv) {
            const resultsDiv = document.getElementById(targetDiv);
            
            if (data.status === 'error') {
                resultsDiv.innerHTML = '<div class="prediction-item severity-high">Error: ' + data.message + '</div>';
                return;
            }

            let notificationHtml = '';
            notificationHtml += '<div class="notification-status">';
            notificationHtml += '<h4>üìß Notifications Sent Successfully</h4>';
            notificationHtml += '<p>‚úÖ Detailed report sent to your email address</p>';
            if (data.notifications && data.notifications.sms && data.notifications.sms.sent) {
                // notificationHtml += '<p>‚úÖ SMS alert sent to your registered phone number</p>';
            }
            notificationHtml += '<p><small>Check your email for comprehensive treatment recommendations and pesticide details.</small></p>';
            notificationHtml += '</div>';

            // Check if predictions exist and have data
            const hasPredictions = data.predictions && data.predictions.length > 0;
            const hasDiseases = hasPredictions && data.predictions.some(pred => 
                pred.class && pred.class !== 'healthy' && pred.confidence > 0.5
            );

            if (!hasDiseases) {
                resultsDiv.innerHTML = notificationHtml + `
                    <div class="prediction-item severity-none">
                        <h3>‚úÖ No Disease Spots Detected</h3>
                        <p>The coffee leaf appears healthy with no visible disease spots.</p>
                        ${data.image_with_boxes ? `
                            <div class="preview-container">
                                <h3>Analyzed Image:</h3>
                                <img src="data:image/jpeg;base64,${data.image_with_boxes}" class="preview-image">
                            </div>
                        ` : ''}
                        <div class="action-buttons">
                            <button class="btn btn-info" onclick="downloadPDFReport()">üì• Download PDF Report</button>
                            <button class="btn btn-secondary" onclick="openHistoryModal()">üìã View History</button>
                            <button class="btn btn-success" onclick="captureAnother()">üîÑ Capture Another</button>
                        </div>
                    </div>
                `;
                return;
            }

            let html = notificationHtml + '<h3>üéØ Disease Spots Detected & Marked</h3>';
            
            if (data.metrics) {
                html += `
                    <div class="metrics-panel">
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">Disease Spots Found</div>
                                <div class="metric-value">${data.metrics.spots_found || data.predictions.length}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Diseases Identified</div>
                                <div class="metric-value">${data.metrics.diseases_identified || new Set(data.predictions.map(p => p.class)).size}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Leaf Status</div>
                                <div class="metric-value">${(data.metrics.leaf_status || 'DISEASED').toUpperCase()}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (data.image_with_boxes) {
                html += `
                    <div class="preview-container">
                        <h3>üîç Marked Disease Spots:</h3>
                        <p><small>Colored boxes show detected disease areas</small></p>
                        <img src="data:image/jpeg;base64,${data.image_with_boxes}" class="preview-image" style="border: 3px solid #667eea;">
                        <div style="margin-top: 15px; text-align: center;">
                            <div style="display: inline-flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <div style="width: 20px; height: 3px; background: #4CAF50;"></div>
                                    <span>Healthy</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <div style="width: 20px; height: 3px; background: #110ee6;"></div>
                                    <span>Rust</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <div style="width: 20px; height: 3px; background: #0077ff;"></div>
                                    <span>Miner</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <div style="width: 20px; height: 3px; background: #07219e;"></div>
                                    <span>Phoma</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '<div style="margin-top: 30px;"><h3>üíä Disease Treatment & Management</h3></div>';
            
            // Group predictions by disease type
            const diseaseGroups = {};
            data.predictions.forEach(pred => {
                if (pred.class && pred.class !== 'healthy') {
                    if (!diseaseGroups[pred.class]) {
                        diseaseGroups[pred.class] = [];
                    }
                    diseaseGroups[pred.class].push(pred);
                }
            });

            // Display individual disease information
            Object.entries(diseaseGroups).forEach(([diseaseClass, predictions]) => {
                const firstPred = predictions[0];
                const severityClass = `severity-${(firstPred.disease_info?.severity || 'medium').toLowerCase()}`;
                const confidence = predictions.reduce((sum, p) => sum + p.confidence, 0) / predictions.length;
                const diseaseName = firstPred.disease_info?.name || diseaseClass.charAt(0).toUpperCase() + diseaseClass.slice(1);
                const diseaseDescription = firstPred.disease_info?.description || `This appears to be ${diseaseName} infection.`;
                
                html += `
                    <div class="prediction-item ${severityClass}">
                        <h3>${getDiseaseEmoji(diseaseClass)} ${diseaseName}</h3>
                        <p><strong>Spots Detected:</strong> ${predictions.length} areas | <strong>Average Confidence:</strong> ${Math.round(confidence * 100)}%</p>
                        <p><strong>Description:</strong> ${diseaseDescription}</p>
                        
                        <div class="disease-info">
                            <h4>üõ°Ô∏è Recommended Pesticides & Treatments:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 10px;">
                `;
                
                // Display pesticides for diseases that have them
                if (firstPred.disease_info?.pesticides && firstPred.disease_info.pesticides.length > 0) {
                    firstPred.disease_info.pesticides.forEach(pesticide => {
                        html += `
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                                <strong>${pesticide.name}</strong><br>
                                <small>Type: ${pesticide.type} | Dosage: ${pesticide.dosage}</small><br>
                                <small>Frequency: ${pesticide.frequency}</small>
                            </div>
                        `;
                    });
                } else {
                    // Default pesticides based on disease type
                    const defaultPesticides = getDefaultPesticides(diseaseClass);
                    defaultPesticides.forEach(pesticide => {
                        html += `
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                                <strong>${pesticide.name}</strong><br>
                                <small>Type: ${pesticide.type} | Dosage: ${pesticide.dosage}</small><br>
                                <small>Frequency: ${pesticide.frequency}</small>
                            </div>
                        `;
                    });
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });

            // Add general treatment recommendations (only once, not for each disease)
            html += `
                <div class="prediction-item" style="background: #e8f4fd; border-left: 4px solid #2196F3;">
                    <h3>üìã Application Method & Preventive Measures</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                        <div>
                            <h4>üõ†Ô∏è Application Method:</h4>
                            <ul style="margin-left: 20px;">
                                <li>Apply recommended pesticides evenly on affected areas</li>
                                <li>Spray during early morning or late afternoon</li>
                                <li>Ensure complete coverage of both leaf surfaces</li>
                                <li>Repeat applications as directed by frequency guidelines</li>
                                <li>Avoid spraying during windy or rainy conditions</li>
                            </ul>
                        </div>
                        <div>
                            <h4>üå± Preventive Measures:</h4>
                            <ul style="margin-left: 20px;">
                                <li>Regular monitoring and inspection of plants</li>
                                <li>Maintain proper plant spacing for air circulation</li>
                                <li>Ensure good drainage and avoid waterlogging</li>
                                <li>Practice proper sanitation and remove infected leaves</li>
                                <li>Use disease-resistant coffee varieties when possible</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; background: rgba(255,193,7,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #FFC107;">
                        <h4>‚ö†Ô∏è Important Notes:</h4>
                        <ul style="margin-left: 20px;">
                            <li>Always wear protective equipment when applying pesticides</li>
                            <li>Follow recommended waiting periods before harvest</li>
                            <li>Rotate pesticides to prevent resistance</li>
                            <li>Consult local agricultural experts for specific recommendations</li>
                            
                        </ul>
                    </div>
                </div>
            `;

            // Add general agricultural advice
            html += `
                <div class="prediction-item" style="background: #e3f2fd; border-left: 4px solid #2196F3;">
                    <h3>üåø General Coffee Plant Care Recommendations</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div>
                            <h4>üíß Water Management</h4>
                            <ul style="margin-left: 20px;">
                                <li>Maintain consistent soil moisture</li>
                                <li>Avoid waterlogging and drought stress</li>
                                <li>Use drip irrigation for efficiency</li>
                                
                            </ul>
                        </div>
                        <div>
                            <h4>üå± Nutrient Management</h4>
                            <ul style="margin-left: 20px;">
                                <li>Conduct regular soil testing</li>
                                <li>Apply balanced NPK fertilizers</li>
                                
                                <li>Use micronutrients as needed</li>
                            </ul>
                        </div>
                        <div>
                            <h4>‚úÇÔ∏è Pruning & Maintenance</h4>
                            <ul style="margin-left: 20px;">
                                <li>Regular pruning for air circulation</li>
                                <li>Remove diseased and dead plant parts</li>
                                <li>Maintain proper shade levels</li>
                                
                            </ul>
                        </div>
                    </div>
                </div>
            `;

            // Add action buttons
            html += `
                <div class="action-buttons">
                    <button class="btn btn-info" onclick="downloadPDFReport()">üì• Download PDF Report</button>
                    <button class="btn btn-secondary" onclick="openHistoryModal()">üìã View History</button>
                    ${targetDiv === 'webcamResults' ? '<button class="btn btn-success" onclick="captureAnother()">üîÑ Capture Another</button>' : '<button class="btn btn-success" onclick="analyzeAnother()">üîÑ Analyze Another</button>'}
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        // Helper function for disease emojis
        function getDiseaseEmoji(disease) {
            const emojis = {
                'healthy': '‚úÖ',
                'rust': 'üü†',
                'miner': 'üêõ',
                'phoma': 'üü§',
                'cercospora': 'üçÇ',
                'anthracnose': 'üî¥',
                'blight': 'üíÄ'
            };
            return emojis[disease.toLowerCase()] || 'üîç';
        }

        // Helper function for default pesticides
        function getDefaultPesticides(diseaseClass) {
            const pesticides = {
                'rust': [
                    { name: 'Copper Fungicide', type: 'Fungicide', dosage: '2-3g/L', frequency: 'Every 15 days' },
                    { name: 'Triadimefon', type: 'Systemic Fungicide', dosage: '1-2g/L', frequency: 'Every 21 days' }
                ],
                'miner': [
                    { name: 'Neem Oil', type: 'Organic Insecticide', dosage: '5-10ml/L', frequency: 'Weekly' },
                    { name: 'Cypermethrin', type: 'Insecticide', dosage: '1-2ml/L', frequency: 'Every 14 days' }
                ],
                'phoma': [
                    { name: 'Mancozeb', type: 'Fungicide', dosage: '2-3g/L', frequency: 'Every 10 days' },
                    { name: 'Carbendazim', type: 'Systemic Fungicide', dosage: '1-2g/L', frequency: 'Every 15 days' }
                ]
            };
            return pesticides[diseaseClass] || [
                { name: 'Copper-Based Fungicide', type: 'Fungicide', dosage: '2-3g/L', frequency: 'Every 15 days' },
                { name: 'Systemic Fungicide', type: 'Fungicide', dosage: '1-2g/L', frequency: 'As needed' }
            ];
        }

        // Download PDF report function
        async function downloadPDFReport() {
            if (!currentAnalysisData) {
                alert('No analysis data available to download.');
                return;
            }

            try {
                const originalText = event.target.innerHTML;
                event.target.innerHTML = '‚è≥ Generating PDF...';
                event.target.disabled = true;

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPosition = 20;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                const contentWidth = pageWidth - (2 * margin);

                doc.setFontSize(20);
                doc.setTextColor(102, 126, 234);
                doc.text(' Coffee Leaf Disease Detection Report', pageWidth / 2, yPosition, { align: 'center' });
                
                yPosition += 15;
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated on: ${new Date().toLocaleString()}`, pageWidth / 2, yPosition, { align: 'center' });
                
                yPosition += 20;

                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text('Analysis Summary', margin, yPosition);
                yPosition += 10;

                doc.setFontSize(10);
                if (currentAnalysisData.metrics) {
                    const metrics = currentAnalysisData.metrics;
                    doc.text(`‚Ä¢ Disease Spots Found: ${metrics.spots_found}`, margin, yPosition);
                    yPosition += 6;
                    doc.text(`‚Ä¢ Diseases Identified: ${metrics.diseases_identified}`, margin, yPosition);
                    yPosition += 6;
                    doc.text(`‚Ä¢ Leaf Status: ${metrics.leaf_status.toUpperCase()}`, margin, yPosition);
                    yPosition += 15;
                }

                if (currentAnalysisData.predictions && currentAnalysisData.predictions.length > 0) {
                    doc.setFontSize(16);
                    doc.text('Detected Diseases & Treatments', margin, yPosition);
                    yPosition += 15;

                    const diseaseGroups = {};
                    currentAnalysisData.predictions.forEach(pred => {
                        if (!diseaseGroups[pred.class]) {
                            diseaseGroups[pred.class] = [];
                        }
                        diseaseGroups[pred.class].push(pred);
                    });

                    Object.entries(diseaseGroups).forEach(([diseaseClass, predictions]) => {
                        const firstPred = predictions[0];
                        const avgConfidence = (predictions.reduce((sum, p) => sum + p.confidence, 0) / predictions.length) * 100;

                        if (yPosition > 250) {
                            doc.addPage();
                            yPosition = 20;
                        }

                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        const diseaseName = firstPred.disease_info?.name || diseaseClass.charAt(0).toUpperCase() + diseaseClass.slice(1);
                        doc.text(`${diseaseName} (${predictions.length} spots, ${Math.round(avgConfidence)}% confidence)`, margin, yPosition);
                        yPosition += 7;

                        doc.setFontSize(10);
                        doc.text(`Description: ${firstPred.disease_info?.description || 'Coffee leaf disease detected'}`, margin, yPosition);
                        yPosition += 5;

                        if (firstPred.disease_info?.pesticides && firstPred.disease_info.pesticides.length > 0) {
                            yPosition += 3;
                            doc.text('Recommended Pesticides:', margin, yPosition);
                            yPosition += 5;
                            
                            firstPred.disease_info.pesticides.forEach(pesticide => {
                                const pesticideText = `‚Ä¢ ${pesticide.name} (${pesticide.type}): ${pesticide.dosage}, ${pesticide.frequency}`;
                                const lines = doc.splitTextToSize(pesticideText, contentWidth);
                                lines.forEach(line => {
                                    if (yPosition > 270) {
                                        doc.addPage();
                                        yPosition = 20;
                                    }
                                    doc.text(line, margin + 5, yPosition);
                                    yPosition += 5;
                                });
                            });
                        }

                        yPosition += 10;
                    });

                    // Add general treatment recommendations (only once)
                    if (yPosition > 200) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    doc.setFontSize(16);
                    doc.text('Application Method & Preventive Measures', margin, yPosition);
                    yPosition += 10;

                    doc.setFontSize(10);
                    const applicationMethods = [
                        'Application Method:',
                        '‚Ä¢ Apply recommended pesticides evenly on affected areas',
                        '‚Ä¢ Spray during early morning or late afternoon',
                        '‚Ä¢ Ensure complete coverage of both leaf surfaces',
                        '‚Ä¢ Repeat applications as directed by frequency guidelines',
                        // '‚Ä¢ Avoid spraying during windy or rainy conditions',
                        '',
                        'Preventive Measures:',
                        '‚Ä¢ Regular monitoring and inspection of plants',
                        '‚Ä¢ Maintain proper plant spacing for air circulation',
                        '‚Ä¢ Ensure good drainage and avoid waterlogging',
                        '‚Ä¢ Practice proper sanitation and remove infected leaves',
                        // '‚Ä¢ Use disease-resistant coffee varieties when possible',
                        '',
                        'Important Notes:',
                        '‚Ä¢ Always wear protective equipment when applying pesticides',
                        '‚Ä¢ Follow recommended waiting periods before harvest',
                        '‚Ä¢ Rotate pesticides to prevent resistance',
                        '‚Ä¢ Consult local agricultural experts for specific recommendations',
                        // '‚Ä¢ Test on small area before full application'
                    ];

                    applicationMethods.forEach(text => {
                        if (yPosition > 270) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        const lines = doc.splitTextToSize(text, contentWidth);
                        lines.forEach(line => {
                            doc.text(line, margin, yPosition);
                            yPosition += 5;
                        });
                        yPosition += 2;
                    });
                } else {
                    doc.text('‚úÖ No disease spots detected - Leaf appears healthy', margin, yPosition);
                    yPosition += 15;
                }

                if (yPosition > 200) {
                    doc.addPage();
                    yPosition = 20;
                }

                doc.setFontSize(16);
                doc.text('General Coffee Plant Care', margin, yPosition);
                yPosition += 10;

                doc.setFontSize(10);
                const recommendations = [
                    ' Water Management: Maintain consistent soil moisture, avoid waterlogging',
                    ' Nutrient Management: Regular soil testing, balanced NPK fertilizers',
                    ' Pruning: Regular pruning for air circulation, remove diseased parts',
                    ' Protection: Monitor regularly, use protective equipment with pesticides'
                ];

                recommendations.forEach(rec => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    const lines = doc.splitTextToSize(rec, contentWidth);
                    lines.forEach(line => {
                        doc.text(line, margin, yPosition);
                        yPosition += 5;
                    });
                    yPosition += 2;
                });

                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`Page ${i} of ${totalPages}  Coffee Leaf Detection System`, pageWidth / 2, 285, { align: 'center' });
                }

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                doc.save(`coffee_leaf_report_${timestamp}.pdf`);

                event.target.innerHTML = originalText;
                event.target.disabled = false;

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF report: ' + error.message);
                
                event.target.innerHTML = 'üì• Download PDF Report';
                event.target.disabled = false;
            }
        }

        // History Modal Functions
        function openHistoryModal() {
            document.getElementById('historyModal').style.display = 'block';
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function viewHistoryReport(id) {
            const historyItem = analysisHistory.find(item => item.id === id);
            if (historyItem) {
                currentAnalysisData = historyItem.data;
                closeHistoryModal();
                if (historyItem.source === 'image') {
                    switchTab('imageTab');
                    displayResultsWithMarkedImage(historyItem.data, 'imageResults');
                } else {
                    switchTab('webcamTab');
                    displayResultsWithMarkedImage(historyItem.data, 'webcamResults');
                }
            }
        }

        function downloadHistoryPDF(id) {
            const historyItem = analysisHistory.find(item => item.id === id);
            if (!historyItem) return;
            
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '‚è≥ Generating...';
            button.disabled = true;
            
            const originalData = currentAnalysisData;
            currentAnalysisData = historyItem.data;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = 20;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 20;
            const contentWidth = pageWidth - (2 * margin);

            doc.setFontSize(20);
            doc.setTextColor(102, 126, 234);
            doc.text(' Coffee Leaf Disease Detection Report', pageWidth / 2, yPosition, { align: 'center' });
            
            yPosition += 15;
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on: ${historyItem.timestamp}`, pageWidth / 2, yPosition, { align: 'center' });
            
            yPosition += 20;

            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('Analysis Summary', margin, yPosition);
            yPosition += 10;

            doc.setFontSize(10);
            if (historyItem.data.metrics) {
                const metrics = historyItem.data.metrics;
                doc.text(`‚Ä¢ Disease Spots Found: ${metrics.spots_found}`, margin, yPosition);
                yPosition += 6;
                doc.text(`‚Ä¢ Diseases Identified: ${metrics.diseases_identified}`, margin, yPosition);
                yPosition += 6;
                doc.text(`‚Ä¢ Leaf Status: ${metrics.leaf_status.toUpperCase()}`, margin, yPosition);
                yPosition += 15;
            }

            if (historyItem.data.predictions && historyItem.data.predictions.length > 0) {
                doc.setFontSize(16);
                doc.text('Detected Diseases & Treatments', margin, yPosition);
                yPosition += 15;

                const diseaseGroups = {};
                historyItem.data.predictions.forEach(pred => {
                    if (!diseaseGroups[pred.class]) {
                        diseaseGroups[pred.class] = [];
                    }
                    diseaseGroups[pred.class].push(pred);
                });

                Object.entries(diseaseGroups).forEach(([diseaseClass, predictions]) => {
                    const firstPred = predictions[0];
                    const avgConfidence = (predictions.reduce((sum, p) => sum + p.confidence, 0) / predictions.length) * 100;

                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 20;
                    }

                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    const diseaseName = firstPred.disease_info?.name || diseaseClass.charAt(0).toUpperCase() + diseaseClass.slice(1);
                    doc.text(`${diseaseName} (${predictions.length} spots, ${Math.round(avgConfidence)}% confidence)`, margin, yPosition);
                    yPosition += 7;

                    doc.setFontSize(10);
                    doc.text(`Description: ${firstPred.disease_info?.description || 'Coffee leaf disease detected'}`, margin, yPosition);
                    yPosition += 5;

                    if (firstPred.disease_info?.pesticides && firstPred.disease_info.pesticides.length > 0) {
                        yPosition += 3;
                        doc.text('Recommended Pesticides:', margin, yPosition);
                        yPosition += 5;
                        
                        firstPred.disease_info.pesticides.forEach(pesticide => {
                            const pesticideText = `‚Ä¢ ${pesticide.name} (${pesticide.type}): ${pesticide.dosage}, ${pesticide.frequency}`;
                            const lines = doc.splitTextToSize(pesticideText, contentWidth);
                            lines.forEach(line => {
                                if (yPosition > 270) {
                                    doc.addPage();
                                    yPosition = 20;
                                }
                                doc.text(line, margin + 5, yPosition);
                                yPosition += 5;
                            });
                        });
                    }

                    yPosition += 10;
                });

                // Add general treatment recommendations (only once)
                if (yPosition > 200) {
                    doc.addPage();
                    yPosition = 20;
                }

                doc.setFontSize(16);
                doc.text('Application Method & Preventive Measures', margin, yPosition);
                yPosition += 10;

                doc.setFontSize(10);
                const applicationMethods = [
                    'Application Method:',
                    '‚Ä¢ Apply recommended pesticides evenly on affected areas',
                    '‚Ä¢ Spray during early morning or late afternoon',
                    '‚Ä¢ Ensure complete coverage of both leaf surfaces',
                    '‚Ä¢ Repeat applications as directed by frequency guidelines',
                    // '‚Ä¢ Avoid spraying during windy or rainy conditions',
                    '',
                    'Preventive Measures:',
                    '‚Ä¢ Regular monitoring and inspection of plants',
                    '‚Ä¢ Maintain proper plant spacing for air circulation',
                    '‚Ä¢ Ensure good drainage and avoid waterlogging',
                    '‚Ä¢ Practice proper sanitation and remove infected leaves',
                    // '‚Ä¢ Use disease-resistant coffee varieties when possible',
                    '',
                    'Important Notes:',
                    '‚Ä¢ Always wear protective equipment when applying pesticides',
                    '‚Ä¢ Follow recommended waiting periods before harvest',
                    '‚Ä¢ Rotate pesticides to prevent resistance',
                    '‚Ä¢ Consult local agricultural experts for specific recommendations',
                    '‚Ä¢ Test on small area before full application'
                ];

                applicationMethods.forEach(text => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    const lines = doc.splitTextToSize(text, contentWidth);
                    lines.forEach(line => {
                        doc.text(line, margin, yPosition);
                        yPosition += 5;
                    });
                    yPosition += 2;
                });
            } else {
                doc.text('‚úÖ No disease spots detected - Leaf appears healthy', margin, yPosition);
                yPosition += 15;
            }

            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Page ${i} of ${totalPages}  Coffee Leaf Detection System`, pageWidth / 2, 285, { align: 'center' });
            }

            const filename = `coffee_analysis_${historyItem.timestamp.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
            doc.save(filename);

            currentAnalysisData = originalData;
            button.innerHTML = originalText;
            button.disabled = false;
        }

        function deleteHistoryItem(id) {
            if (confirm('Are you sure you want to delete this analysis from history?')) {
                analysisHistory = analysisHistory.filter(item => item.id !== id);
                saveHistory();
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target === modal) {
                closeHistoryModal();
            }
        }

        // Capture another image (for camera)
        function captureAnother() {
            const resultsDiv = document.getElementById('webcamResults');
            resultsDiv.innerHTML = `
                <div class="prediction-item">
                    <strong>üì± Camera Ready</strong><br>
                    Camera is active. Click the capture button to take another photo.
                </div>
            `;
            
            document.getElementById('cameraPreview').classList.add('hidden');
            document.getElementById('analysisProgress').classList.add('hidden');
            currentCapturedImage = null;
            currentAnalysisData = null;
            
            // Restart camera for another capture
            startCamera();
        }

        // Analyze another image (for upload)
        function analyzeAnother() {
            document.getElementById('fileInput').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('imageResults').innerHTML = '';
            currentAnalysisData = null;
        }

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (isCameraActive) {
                stopCamera();
            }
        });
    </script>
</body>
</html>